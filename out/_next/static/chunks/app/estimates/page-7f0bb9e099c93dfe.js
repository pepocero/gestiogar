(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4801],{86206:function(e,s,t){Promise.resolve().then(t.bind(t,86368))},86368:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return w}});var a=t(57437),i=t(2265),r=t(46281),l=t(99178),n=t(84226),c=t(38068),d=t(95998),o=t(69379),u=t(2141),m=t(69064),x=t(99397),h=t(48736),p=t(92369),j=t(31047),g=t(42208),f=t(94630),b=t(18930),y=t(89345),v=t(29525),N=t(77127),_=t(89048);function w(){let{company:e}=(0,r.a)(),[s,t]=(0,i.useState)([]),[w,E]=(0,i.useState)(!0),[C,I]=(0,i.useState)(!1),[S,Z]=(0,i.useState)(!1),[k,T]=(0,i.useState)(null),[z,D]=(0,i.useState)(!1),[O,M]=(0,i.useState)(null),[q,P]=(0,i.useState)([]),[A,L]=(0,i.useState)([]),[F,H]=(0,i.useState)([]),[R,G]=(0,i.useState)([]),[J,U]=(0,i.useState)({search:"",status:"",client_id:"",job_id:""}),[V,W]=(0,i.useState)([]),[B,Y]=(0,i.useState)({title:"",description:"",client_id:"",job_id:"",valid_until:"",notes:""}),[X,K]=(0,i.useState)({description:"",quantity:1,unit_price:0,is_labor:!1,material_id:""});(0,i.useEffect)(()=>{e&&(Q(),et(),ea(),ei())},[e]);let Q=async()=>{try{E(!0);let{data:s,error:a}=await u.supabase.from("estimates").select("\n          *,\n          clients!inner(first_name, last_name, email, phone),\n          jobs(job_number, title)\n        ").eq("company_id",e.id).order("created_at",{ascending:!1});if(a)throw a;t(s||[])}catch(e){console.error("Error loading estimates:",e),m.ZP.error("Error al cargar los presupuestos")}finally{E(!1)}},$=()=>{let e=s;if(J.search){let s=J.search.toLowerCase();e=e.filter(e=>{var t,a,i,r,l;return e.title.toLowerCase().includes(s)||e.estimate_number.toLowerCase().includes(s)||(null===(t=e.description)||void 0===t?void 0:t.toLowerCase().includes(s))||(null===(i=e.clients)||void 0===i?void 0:null===(a=i.first_name)||void 0===a?void 0:a.toLowerCase().includes(s))||(null===(l=e.clients)||void 0===l?void 0:null===(r=l.last_name)||void 0===r?void 0:r.toLowerCase().includes(s))})}J.status&&(e=e.filter(e=>e.status===J.status)),J.client_id&&(e=e.filter(e=>e.client_id===J.client_id)),J.job_id&&(e=e.filter(e=>e.job_id===J.job_id)),W(e)};(0,i.useEffect)(()=>{$()},[s,J]);let ee=(e,s)=>{U(t=>({...t,[e]:s}))},es=()=>{U({search:"",status:"",client_id:"",job_id:""})},et=async()=>{try{let{data:s,error:t}=await u.supabase.from("clients").select("id, first_name, last_name, email").eq("company_id",e.id).order("first_name");if(t)throw t;L(s||[])}catch(e){console.error("Error loading clients:",e)}},ea=async()=>{try{let{data:s,error:t}=await u.supabase.from("jobs").select("id, job_number, title, status").eq("company_id",e.id).in("status",["pending","scheduled"]).order("job_number");if(t)throw t;H(s||[])}catch(e){console.error("Error loading jobs:",e)}},ei=async()=>{try{let{data:s,error:t}=await u.supabase.from("materials").select("id, name, selling_price, unit").eq("company_id",e.id).eq("is_active",!0).order("name");if(t)throw t;G(s||[])}catch(e){console.error("Error loading materials:",e)}},er=async e=>{try{let{data:s,error:t}=await u.supabase.from("estimate_items").select("*").eq("estimate_id",e).order("created_at");if(t)throw t;P(s||[])}catch(e){console.error("Error loading estimate items:",e)}},el=e=>{let{name:s,value:t,type:a}=e.target,i=e.target.checked;Y(e=>({...e,[s]:"checkbox"===a?i:t}))},en=e=>{let{name:s,value:t,type:a}=e.target,i=e.target.checked;K(e=>({...e,[s]:"checkbox"===a?i:t}))},ec=()=>{let e=new Date().getFullYear(),s=String(new Date().getMonth()+1).padStart(2,"0"),t=Math.floor(1e3*Math.random()).toString().padStart(3,"0");return"EST-".concat(e).concat(s,"-").concat(t)},ed=async s=>{if(s.preventDefault(),e)try{let s=ec(),t=q.reduce((e,s)=>e+s.total_price,0),a=q.filter(e=>e.is_labor).reduce((e,s)=>e+s.total_price,0),i=q.filter(e=>!e.is_labor).reduce((e,s)=>e+s.total_price,0);if(k){let{error:e}=await u.supabase.from("estimates").update({...B,total_amount:t,labor_amount:a,materials_amount:i}).eq("id",k.id);if(e)throw e;if(q.length>0){let{error:e}=await u.supabase.from("estimate_items").delete().eq("estimate_id",k.id);if(e)throw e;let s=q.map(e=>({description:e.description,quantity:e.quantity,unit_price:e.unit_price,total_price:e.total_price,is_labor:e.is_labor,material_id:e.material_id&&""!==e.material_id.trim()?e.material_id:null,estimate_id:k.id})),{error:t}=await u.supabase.from("estimate_items").insert(s);if(t)throw t}m.ZP.success("Presupuesto actualizado correctamente")}else{let{data:r,error:l}=await u.supabase.from("estimates").insert([{...B,estimate_number:s,total_amount:t,labor_amount:a,materials_amount:i,company_id:e.id}]).select().single();if(l)throw l;if(q.length>0){let e=q.map(e=>({description:e.description,quantity:e.quantity,unit_price:e.unit_price,total_price:e.total_price,is_labor:e.is_labor,material_id:e.material_id&&""!==e.material_id.trim()?e.material_id:null,estimate_id:r.id})),{error:s}=await u.supabase.from("estimate_items").insert(e);if(s)throw s}m.ZP.success("Presupuesto creado correctamente")}I(!1),T(null),ep(),Q()}catch(e){console.error("Error saving estimate:",e),m.ZP.error("Error al guardar el presupuesto")}},eo=async e=>{T(e),Y({title:e.title,description:e.description,client_id:e.client_id||"",job_id:e.job_id||"",valid_until:e.valid_until?e.valid_until.split("T")[0]:"",notes:e.notes}),await er(e.id),I(!0)},eu=async e=>{if(confirm("\xbfEst\xe1s seguro de que quieres eliminar este presupuesto?"))try{let{error:s}=await u.supabase.from("estimates").delete().eq("id",e);if(s)throw s;m.ZP.success("Presupuesto eliminado correctamente"),Q()}catch(e){console.error("Error deleting estimate:",e),m.ZP.error("Error al eliminar el presupuesto")}},em=async e=>{M(e),D(!0);try{let{data:s,error:t}=await u.supabase.from("estimate_items").select("*").eq("estimate_id",e.id).order("created_at");t?console.error("Error loading estimate items:",t):P(s||[])}catch(e){console.error("Error loading estimate items:",e)}},ex=async(e,s)=>{try{let{error:t}=await u.supabase.from("estimates").update({status:s}).eq("id",e);if(t)throw t;m.ZP.success("Estado actualizado correctamente"),Q()}catch(e){console.error("Error updating status:",e),m.ZP.error("Error al actualizar el estado")}},eh=e=>{P(s=>s.filter(s=>s.id!==e))},ep=()=>{Y({title:"",description:"",client_id:"",job_id:"",valid_until:"",notes:""}),P([])},ej=()=>{T(null),ep(),I(!0)};return w?(0,a.jsx)("div",{className:"flex items-center justify-center h-64",children:(0,a.jsx)("div",{className:"spinner"})}):(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:"Presupuestos"}),(0,a.jsx)("p",{className:"text-gray-600",children:"Gestiona los presupuestos para tus trabajos."})]}),(0,a.jsxs)(n.z,{onClick:ej,className:"flex items-center space-x-2",children:[(0,a.jsx)(x.Z,{className:"h-4 w-4"}),(0,a.jsx)("span",{children:"Nuevo Presupuesto"})]})]}),(0,a.jsxs)(l.Zb,{children:[(0,a.jsx)(l.Ol,{children:(0,a.jsx)("h3",{className:"text-lg font-medium text-gray-900",children:"Filtros"})}),(0,a.jsxs)(l.eW,{children:[(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"form-label",children:"Buscar"}),(0,a.jsx)("input",{type:"text",placeholder:"T\xedtulo, n\xfamero, cliente...",value:J.search,onChange:e=>ee("search",e.target.value),className:"form-input"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"form-label",children:"Estado"}),(0,a.jsxs)("select",{value:J.status,onChange:e=>ee("status",e.target.value),className:"form-input",children:[(0,a.jsx)("option",{value:"",children:"Todos los estados"}),(0,a.jsx)("option",{value:"draft",children:"Borrador"}),(0,a.jsx)("option",{value:"sent",children:"Enviado"}),(0,a.jsx)("option",{value:"approved",children:"Aprobado"}),(0,a.jsx)("option",{value:"rejected",children:"Rechazado"})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"form-label",children:"Cliente"}),(0,a.jsxs)("select",{value:J.client_id,onChange:e=>ee("client_id",e.target.value),className:"form-input",children:[(0,a.jsx)("option",{value:"",children:"Todos los clientes"}),A.map(e=>(0,a.jsxs)("option",{value:e.id,children:[e.first_name," ",e.last_name]},e.id))]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"form-label",children:"Trabajo"}),(0,a.jsxs)("select",{value:J.job_id,onChange:e=>ee("job_id",e.target.value),className:"form-input",children:[(0,a.jsx)("option",{value:"",children:"Todos los trabajos"}),F.map(e=>(0,a.jsxs)("option",{value:e.id,children:[e.job_number," - ",e.title]},e.id))]})]})]}),(0,a.jsx)("div",{className:"flex justify-end mt-4",children:(0,a.jsx)(n.z,{variant:"outline",onClick:es,className:"text-sm",children:"Limpiar Filtros"})})]})]}),(0,a.jsxs)(l.Zb,{children:[(0,a.jsx)(l.Ol,{children:(0,a.jsxs)("h3",{className:"text-lg font-medium text-gray-900",children:["Lista de Presupuestos (",V.length," de ",s.length,")"]})}),(0,a.jsx)(l.eW,{children:V.length>0?(0,a.jsx)("div",{className:"space-y-4",children:V.map(e=>(0,a.jsx)("div",{className:"bg-white border border-gray-200 rounded-xl p-4 hover:shadow-md transition-shadow",children:(0,a.jsxs)("div",{className:"flex items-start justify-between gap-4",children:[(0,a.jsxs)("div",{className:"flex items-start gap-4 min-w-0",children:[(0,a.jsx)("div",{className:"w-10 h-10 rounded-lg bg-primary-50 text-primary-700 flex items-center justify-center shadow-sm flex-shrink-0",children:(0,a.jsx)(h.Z,{className:"h-5 w-5"})}),(0,a.jsxs)("div",{className:"min-w-0",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"font-mono text-xs px-2 py-0.5 bg-gray-100 text-gray-700 rounded",children:e.estimate_number}),(0,a.jsxs)("select",{value:e.status,onChange:s=>ex(e.id,s.target.value),className:"text-xs px-3 py-1 rounded-full border-0 font-medium cursor-pointer transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-1 min-w-[110px] ".concat("draft"===e.status?"bg-gray-100 text-gray-800 focus:ring-gray-500":"sent"===e.status?"bg-blue-100 text-blue-800 focus:ring-blue-500":"approved"===e.status?"bg-green-100 text-green-800 focus:ring-green-500":"bg-red-100 text-red-800 focus:ring-red-500"),children:[(0,a.jsx)("option",{value:"draft",children:"Borrador"}),(0,a.jsx)("option",{value:"sent",children:"Enviado"}),(0,a.jsx)("option",{value:"approved",children:"Aprobado"}),(0,a.jsx)("option",{value:"rejected",children:"Rechazado"})]})]}),(0,a.jsx)("h4",{className:"mt-1 text-base font-semibold text-gray-900 truncate",children:e.title}),e.description&&(0,a.jsx)("p",{className:"text-sm text-gray-500 line-clamp-2 max-w-prose",children:e.description}),(0,a.jsxs)("div",{className:"mt-2 grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-gray-600",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 min-w-0",children:[(0,a.jsx)(p.Z,{className:"h-4 w-4 text-gray-400"}),(0,a.jsxs)("span",{className:"truncate",children:[e.clients.first_name," ",e.clients.last_name]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2 min-w-0",children:[(0,a.jsx)(j.Z,{className:"h-4 w-4 text-gray-400"}),(0,a.jsxs)("span",{className:"truncate",children:["V\xe1lido hasta: ",e.valid_until?(0,N.Z)(new Date(e.valid_until),"dd/MM/yyyy",{locale:_.Z}):"-"]})]})]})]})]}),(0,a.jsxs)("div",{className:"flex flex-col items-end gap-3 flex-shrink-0",children:[(0,a.jsxs)("div",{className:"text-right",children:[(0,a.jsx)("div",{className:"text-xs text-gray-500",children:"Importe total"}),(0,a.jsxs)("div",{className:"text-lg font-semibold text-gray-900",children:["€",e.total_amount.toLocaleString()]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(n.z,{variant:"outline",size:"sm",onClick:()=>em(e),title:"Ver presupuesto",children:(0,a.jsx)(g.Z,{className:"h-4 w-4"})}),(0,a.jsx)(n.z,{variant:"outline",size:"sm",onClick:()=>eo(e),title:"Editar presupuesto",children:(0,a.jsx)(f.Z,{className:"h-4 w-4"})}),(0,a.jsx)(n.z,{variant:"outline",size:"sm",onClick:()=>eu(e.id),title:"Eliminar presupuesto",children:(0,a.jsx)(b.Z,{className:"h-4 w-4"})})]})]})]})},e.id))}):0===s.length?(0,a.jsxs)("div",{className:"text-center py-12",children:[(0,a.jsx)(h.Z,{className:"mx-auto h-12 w-12 text-gray-400"}),(0,a.jsx)("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No hay presupuestos"}),(0,a.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:"Comienza creando tu primer presupuesto."}),(0,a.jsx)("div",{className:"mt-6",children:(0,a.jsxs)(n.z,{onClick:ej,children:[(0,a.jsx)(x.Z,{className:"h-4 w-4 mr-2"}),"Nuevo Presupuesto"]})})]}):(0,a.jsxs)("div",{className:"text-center py-12",children:[(0,a.jsx)(h.Z,{className:"mx-auto h-12 w-12 text-gray-400"}),(0,a.jsx)("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No se encontraron presupuestos"}),(0,a.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:"Intenta ajustar los filtros de b\xfasqueda."}),(0,a.jsx)("div",{className:"mt-6",children:(0,a.jsx)(n.z,{variant:"outline",onClick:es,children:"Limpiar Filtros"})})]})})]}),(0,a.jsx)(d.u,{isOpen:C,onClose:()=>I(!1),title:k?"Editar Presupuesto":"Nuevo Presupuesto",size:"xl",children:(0,a.jsxs)("form",{onSubmit:ed,className:"space-y-6",children:[(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,a.jsx)("div",{children:(0,a.jsx)(c.I,{label:"T\xedtulo del Presupuesto *",name:"title",value:B.title,onChange:el,required:!0})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"form-label",children:"Cliente *"}),(0,a.jsxs)("select",{name:"client_id",value:B.client_id,onChange:el,required:!0,className:"form-input",children:[(0,a.jsx)("option",{value:"",children:"Seleccionar cliente"}),A.map(e=>(0,a.jsxs)("option",{value:e.id,children:[e.first_name," ",e.last_name]},e.id))]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"form-label",children:"Trabajo Relacionado"}),(0,a.jsxs)("select",{name:"job_id",value:B.job_id,onChange:el,className:"form-input",children:[(0,a.jsx)("option",{value:"",children:"Sin trabajo relacionado"}),F.map(e=>(0,a.jsxs)("option",{value:e.id,children:[e.job_number," - ",e.title]},e.id))]})]}),(0,a.jsx)("div",{children:(0,a.jsx)(c.I,{label:"V\xe1lido Hasta",name:"valid_until",type:"date",value:B.valid_until,onChange:el})}),(0,a.jsxs)("div",{className:"md:col-span-2",children:[(0,a.jsx)("label",{className:"form-label",children:"Descripci\xf3n"}),(0,a.jsx)("textarea",{name:"description",value:B.description,onChange:el,rows:3,className:"form-input"})]}),(0,a.jsxs)("div",{className:"md:col-span-2",children:[(0,a.jsx)("label",{className:"form-label",children:"Notas"}),(0,a.jsx)("textarea",{name:"notes",value:B.notes,onChange:el,rows:2,className:"form-input"})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,a.jsx)("h4",{className:"text-lg font-medium text-gray-900",children:"Items del Presupuesto"}),(0,a.jsxs)(n.z,{type:"button",variant:"outline",onClick:()=>Z(!0),children:[(0,a.jsx)(x.Z,{className:"h-4 w-4 mr-2"}),"Agregar Item"]})]}),q.length>0?(0,a.jsxs)("div",{className:"space-y-2",children:[q.map(e=>(0,a.jsxs)("div",{className:"flex items-center justify-between p-3 border border-gray-200 rounded-lg",children:[(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,a.jsx)("span",{className:"font-medium",children:e.description}),e.is_labor&&(0,a.jsx)(o.C,{variant:"info",size:"sm",children:"Mano de Obra"})]}),(0,a.jsxs)("div",{className:"text-sm text-gray-500",children:[e.quantity," x €",e.unit_price.toFixed(2)," = €",e.total_price.toFixed(2)]})]}),(0,a.jsx)(n.z,{type:"button",variant:"outline",size:"sm",onClick:()=>eh(e.id),children:(0,a.jsx)(b.Z,{className:"h-4 w-4"})})]},e.id)),(0,a.jsx)("div",{className:"border-t pt-3",children:(0,a.jsxs)("div",{className:"flex justify-between items-center text-lg font-semibold",children:[(0,a.jsx)("span",{children:"Total:"}),(0,a.jsxs)("span",{children:["€",q.reduce((e,s)=>e+s.total_price,0).toFixed(2)]})]})})]}):(0,a.jsx)("div",{className:"text-center py-8 text-gray-500",children:"No hay items en el presupuesto"})]}),(0,a.jsxs)("div",{className:"flex justify-end space-x-3 pt-4",children:[(0,a.jsx)(n.z,{type:"button",variant:"outline",onClick:()=>I(!1),children:"Cancelar"}),(0,a.jsxs)(n.z,{type:"submit",children:[k?"Actualizar":"Crear"," Presupuesto"]})]})]})}),(0,a.jsx)(d.u,{isOpen:z,onClose:()=>D(!1),title:"Detalles del Presupuesto",size:"lg",children:O&&(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsx)("div",{className:"flex items-start justify-between",children:(0,a.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg",children:(0,a.jsx)(h.Z,{className:"h-8 w-8 text-white"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-2xl font-bold text-gray-900",children:O.estimate_number}),(0,a.jsx)("div",{className:"flex items-center space-x-2 mt-1",children:(e=>{let s={draft:{variant:"gray",label:"Borrador"},sent:{variant:"info",label:"Enviado"},approved:{variant:"success",label:"Aprobado"},rejected:{variant:"danger",label:"Rechazado"}}[e]||{variant:"gray",label:e};return(0,a.jsx)(o.C,{variant:s.variant,children:s.label})})(O.status)})]})]})}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,a.jsxs)("div",{className:"bg-gray-50 rounded-lg p-4",children:[(0,a.jsx)("h3",{className:"text-sm font-medium text-gray-500 uppercase tracking-wide mb-3",children:"Informaci\xf3n del Presupuesto"}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm text-gray-500",children:"T\xedtulo"}),(0,a.jsx)("p",{className:"font-medium text-gray-900",children:O.title})]}),O.description&&(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm text-gray-500",children:"Descripci\xf3n"}),(0,a.jsx)("p",{className:"font-medium text-gray-900",children:O.description})]}),O.valid_until&&(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm text-gray-500",children:"V\xe1lido hasta"}),(0,a.jsx)("p",{className:"font-medium text-gray-900",children:(0,N.Z)(new Date(O.valid_until),"dd/MM/yyyy",{locale:_.Z})})]})]})]}),(0,a.jsxs)("div",{className:"bg-gray-50 rounded-lg p-4",children:[(0,a.jsx)("h3",{className:"text-sm font-medium text-gray-500 uppercase tracking-wide mb-3",children:"Cliente"}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,a.jsx)("div",{className:"w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center",children:(0,a.jsx)(p.Z,{className:"h-4 w-4 text-purple-600"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm text-gray-500",children:"Cliente"}),(0,a.jsxs)("p",{className:"font-medium text-gray-900",children:[O.clients.first_name," ",O.clients.last_name]})]})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,a.jsx)("div",{className:"w-8 h-8 bg-green-100 rounded-full flex items-center justify-center",children:(0,a.jsx)(y.Z,{className:"h-4 w-4 text-green-600"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm text-gray-500",children:"Email"}),(0,a.jsx)("a",{href:"mailto:".concat(O.clients.email),className:"font-medium text-blue-600 hover:text-blue-700",children:O.clients.email})]})]})]})]})]}),O.jobs&&(0,a.jsxs)("div",{className:"bg-gray-50 rounded-lg p-4",children:[(0,a.jsx)("h3",{className:"text-sm font-medium text-gray-500 uppercase tracking-wide mb-3",children:"Trabajo Relacionado"}),(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,a.jsx)("div",{className:"w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center",children:(0,a.jsx)(v.Z,{className:"h-4 w-4 text-blue-600"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm text-gray-500",children:"Trabajo"}),(0,a.jsxs)("p",{className:"font-medium text-gray-900",children:[O.jobs.job_number," - ",O.jobs.title]})]})]})]}),(0,a.jsxs)("div",{className:"bg-gray-50 rounded-lg p-4",children:[(0,a.jsx)("h3",{className:"text-sm font-medium text-gray-500 uppercase tracking-wide mb-3",children:"Detalles Financieros"}),q.length>0&&(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsx)("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"\xcdtems del Presupuesto"}),(0,a.jsx)("div",{className:"space-y-2",children:q.map(e=>(0,a.jsxs)("div",{className:"flex justify-between items-center bg-white rounded p-2 border",children:[(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("p",{className:"text-sm font-medium text-gray-900",children:e.description}),(0,a.jsxs)("p",{className:"text-xs text-gray-500",children:[e.quantity," x €",e.unit_price.toFixed(2)," = €",e.total_price.toFixed(2)]})]}),(0,a.jsx)("div",{className:"text-right",children:(0,a.jsx)("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ".concat(e.is_labor?"bg-blue-100 text-blue-800":"bg-green-100 text-green-800"),children:e.is_labor?"Mano de Obra":"Material"})})]},e.id))})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm text-gray-500",children:"Mano de Obra"}),(0,a.jsxs)("p",{className:"font-medium text-gray-900",children:["€",O.labor_amount.toFixed(2)]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm text-gray-500",children:"Materiales"}),(0,a.jsxs)("p",{className:"font-medium text-gray-900",children:["€",O.materials_amount.toFixed(2)]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm text-gray-500",children:"Total"}),(0,a.jsxs)("p",{className:"font-semibold text-lg text-gray-900",children:["€",O.total_amount.toFixed(2)]})]})]})]}),O.notes&&(0,a.jsxs)("div",{className:"bg-gray-50 rounded-lg p-4",children:[(0,a.jsx)("h3",{className:"text-sm font-medium text-gray-500 uppercase tracking-wide mb-3",children:"Notas"}),(0,a.jsx)("p",{className:"text-gray-900",children:O.notes})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-500",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"font-medium",children:"Creado:"})," ",(0,N.Z)(new Date(O.created_at),"dd/MM/yyyy HH:mm",{locale:_.Z})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"font-medium",children:"Actualizado:"})," ",(0,N.Z)(new Date(O.updated_at),"dd/MM/yyyy HH:mm",{locale:_.Z})]})]}),(0,a.jsxs)("div",{className:"flex justify-end space-x-3 pt-4 border-t",children:[(0,a.jsx)(n.z,{type:"button",variant:"outline",onClick:()=>D(!1),children:"Cerrar"}),(0,a.jsx)(n.z,{type:"button",onClick:async()=>{D(!1),await eo(O)},children:"Editar Presupuesto"})]})]})}),(0,a.jsx)(d.u,{isOpen:S,onClose:()=>Z(!1),title:"Agregar Item al Presupuesto",size:"md",children:(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("div",{children:(0,a.jsx)(c.I,{label:"Descripci\xf3n *",name:"description",value:X.description,onChange:en,required:!0})}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsx)("div",{children:(0,a.jsx)(c.I,{label:"Cantidad *",name:"quantity",type:"number",value:X.quantity,onChange:en,min:"0.01",step:"0.01",required:!0})}),(0,a.jsx)("div",{children:(0,a.jsx)(c.I,{label:"Precio Unitario *",name:"unit_price",type:"number",value:X.unit_price,onChange:en,min:"0",step:"0.01",required:!0})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"form-label",children:"Material"}),(0,a.jsxs)("select",{name:"material_id",value:X.material_id,onChange:en,className:"form-input",children:[(0,a.jsx)("option",{value:"",children:"Seleccionar material (opcional)"}),R.map(e=>(0,a.jsxs)("option",{value:e.id,children:[e.name," - €",e.selling_price," (",e.unit,")"]},e.id))]})]}),(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("input",{id:"is_labor",name:"is_labor",type:"checkbox",checked:X.is_labor,onChange:en,className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"}),(0,a.jsx)("label",{htmlFor:"is_labor",className:"ml-2 block text-sm text-gray-900",children:"Es mano de obra"})]}),(0,a.jsxs)("div",{className:"flex justify-end space-x-3",children:[(0,a.jsx)(n.z,{type:"button",variant:"outline",onClick:()=>Z(!1),children:"Cancelar"}),(0,a.jsx)(n.z,{onClick:()=>{if(!X.description||X.quantity<=0||X.unit_price<0){m.ZP.error("Por favor completa todos los campos del item");return}let e={id:Math.random().toString(36).substr(2,9),description:X.description,quantity:Number(X.quantity),unit_price:Number(X.unit_price),total_price:Number(X.quantity)*Number(X.unit_price),is_labor:X.is_labor,material_id:X.material_id||void 0};P(s=>[...s,e]),K({description:"",quantity:1,unit_price:0,is_labor:!1,material_id:""})},children:"Agregar Item"})]})]})})]})}},69379:function(e,s,t){"use strict";t.d(s,{C:function(){return r}});var a=t(57437);t(2265);var i=t(61994);function r(e){let{children:s,variant:t="gray",size:r="md",className:l}=e;return(0,a.jsx)("span",{className:(0,i.W)("inline-flex items-center font-medium rounded-full",{success:"bg-green-100 text-green-800",warning:"bg-yellow-100 text-yellow-800",danger:"bg-red-100 text-red-800",info:"bg-blue-100 text-blue-800",gray:"bg-gray-100 text-gray-800"}[t],{sm:"px-2 py-0.5 text-xs",md:"px-2.5 py-0.5 text-xs"}[r],l),children:s})}},84226:function(e,s,t){"use strict";t.d(s,{z:function(){return r}});var a=t(57437);t(2265);var i=t(61994);function r(e){let{variant:s="primary",size:t="md",loading:r=!1,className:l,children:n,disabled:c,...d}=e;return(0,a.jsxs)("button",{className:(0,i.W)("inline-flex items-center justify-center font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-200",{primary:"bg-primary-600 text-white hover:bg-primary-700 focus:ring-primary-500",secondary:"bg-gray-200 text-gray-900 hover:bg-gray-300 focus:ring-gray-500",danger:"bg-red-600 text-white hover:bg-red-700 focus:ring-red-500",success:"bg-green-600 text-white hover:bg-green-700 focus:ring-green-500",outline:"border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 focus:ring-primary-500"}[s],{sm:"px-3 py-1.5 text-xs",md:"px-4 py-2 text-sm",lg:"px-6 py-3 text-base"}[t],(c||r)&&"opacity-50 cursor-not-allowed",l),disabled:c||r,...d,children:[r&&(0,a.jsx)("div",{className:"spinner mr-2"}),n]})}},99178:function(e,s,t){"use strict";t.d(s,{Ol:function(){return l},Zb:function(){return r},eW:function(){return n}});var a=t(57437);t(2265);var i=t(61994);function r(e){let{children:s,className:t}=e;return(0,a.jsx)("div",{className:(0,i.W)("card",t),children:s})}function l(e){let{children:s,className:t}=e;return(0,a.jsx)("div",{className:(0,i.W)("card-header",t),children:s})}function n(e){let{children:s,className:t}=e;return(0,a.jsx)("div",{className:(0,i.W)("card-body",t),children:s})}},38068:function(e,s,t){"use strict";t.d(s,{I:function(){return r}});var a=t(57437);t(2265);var i=t(61994);function r(e){let{label:s,error:t,helperText:r,className:l,id:n,...c}=e,d=n||"input-".concat(Math.random().toString(36).substr(2,9));return(0,a.jsxs)("div",{className:"w-full",children:[s&&(0,a.jsx)("label",{htmlFor:d,className:"form-label",children:s}),(0,a.jsx)("input",{id:d,className:(0,i.W)("form-input",t&&"border-red-300 focus:ring-red-500 focus:border-red-500",l),...c}),t&&(0,a.jsx)("p",{className:"form-error",children:t}),r&&!t&&(0,a.jsx)("p",{className:"text-sm text-gray-500 mt-1",children:r})]})}},95998:function(e,s,t){"use strict";t.d(s,{u:function(){return n}});var a=t(57437),i=t(2265),r=t(61994),l=t(32489);function n(e){let{isOpen:s,onClose:t,title:n,children:c,size:d="md",className:o}=e;return((0,i.useEffect)(()=>(s?document.body.style.overflow="hidden":document.body.style.overflow="unset",()=>{document.body.style.overflow="unset"}),[s]),(0,i.useEffect)(()=>{let e=e=>{"Escape"===e.key&&t()};return s&&document.addEventListener("keydown",e),()=>{document.removeEventListener("keydown",e)}},[s,t]),s)?(0,a.jsx)("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:(0,a.jsxs)("div",{className:"flex min-h-screen items-center justify-center p-4",children:[(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 transition-opacity",onClick:t}),(0,a.jsxs)("div",{className:(0,r.W)("relative bg-white rounded-lg shadow-xl w-full",{sm:"max-w-md",md:"max-w-lg",lg:"max-w-2xl",xl:"max-w-4xl"}[d],o),children:[n&&(0,a.jsxs)("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:n}),(0,a.jsx)("button",{onClick:t,className:"text-gray-400 hover:text-gray-600 transition-colors",children:(0,a.jsx)(l.Z,{className:"w-6 h-6"})})]}),(0,a.jsx)("div",{className:"p-6",children:c})]})]})}):null}},46281:function(e,s,t){"use strict";t.d(s,{AuthProvider:function(){return d},a:function(){return o}});var a=t(57437),i=t(2265),r=t(2141),l=t(69064),n=t(26098);let c=(0,i.createContext)(void 0);function d(e){let{children:s}=e,[t,d]=(0,i.useState)(null),[o,u]=(0,i.useState)(null),[m,x]=(0,i.useState)(null),[h,p]=(0,i.useState)(!0),j=async e=>{try{if(o&&o.id===e){(0,n.wH)("debug","\uD83D\uDD04 User profile already loaded, skipping...");return}(0,n.wH)("debug","\uD83D\uDD04 Loading user profile for:",e);let{data:a,error:i}=await r.supabase.from("users").select("\n          *,\n          company:companies(*)\n        ").eq("id",e).single();if(i){console.warn("⚠️ Could not load user profile:",i.message);let e=(await r.supabase.auth.getUser()).data.user;if(e){var s,t;u({id:e.id,email:e.email,first_name:null===(s=e.user_metadata)||void 0===s?void 0:s.first_name,last_name:null===(t=e.user_metadata)||void 0===t?void 0:t.last_name})}return}(0,n.wH)("debug","✅ User profile loaded successfully"),u(a),x(a.company||null)}catch(e){console.warn("⚠️ Error loading user profile:",e)}};(0,i.useEffect)(()=>{let e=!0;(async()=>{try{let{data:{session:s}}=await r.supabase.auth.getSession();(null==s?void 0:s.user)&&e&&(d(s.user),await j(s.user.id))}catch(e){console.error("Error initializing auth:",e)}finally{e&&p(!1)}})();let{data:{subscription:s}}=r.supabase.auth.onAuthStateChange(async(e,s)=>{var t;(0,n.wH)("debug","\uD83D\uDD04 Auth state change:",e,null==s?void 0:null===(t=s.user)||void 0===t?void 0:t.id),"SIGNED_OUT"===e?(d(null),u(null),x(null),l.ZP.success("Sesi\xf3n cerrada")):"SIGNED_IN"===e&&(null==s?void 0:s.user)?(d(s.user),o&&o.id===s.user.id||await j(s.user.id)):"TOKEN_REFRESHED"===e&&(0,n.wH)("debug","\uD83D\uDD04 Token refreshed successfully")}),a=setInterval(async()=>{if(e&&t)try{let{data:{session:e},error:s}=await r.supabase.auth.getSession();(s||!e)&&((0,n.wH)("info","\uD83D\uDD04 Session expired, signing out..."),d(null),u(null),x(null),l.ZP.error("Sesi\xf3n expirada. Por favor, inicia sesi\xf3n nuevamente."))}catch(e){console.warn("⚠️ Error checking session:",e)}},n.ob.SESSION.CHECK_INTERVAL);return()=>{e=!1,s.unsubscribe(),clearInterval(a)}},[]);let g=async(e,s)=>{let{data:t,error:a}=await r.supabase.auth.signInWithPassword({email:e,password:s});if(a)throw a;return t},f=async(e,s,t)=>{let{data:a,error:i}=await r.supabase.auth.signUp({email:e,password:s,options:{data:t}});if(i)throw i;return a},b=async()=>{await r.supabase.auth.signOut()},y=async e=>{if(!t)throw Error("Usuario no autenticado");let{error:s}=await r.supabase.from("users").update(e).eq("id",t.id);if(s)throw s;await j(t.id)};return(0,a.jsx)(c.Provider,{value:{user:t,profile:o,company:m,loading:h,signIn:g,signUp:f,signOut:b,updateProfile:y},children:s})}function o(){let e=(0,i.useContext)(c);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},26098:function(e,s,t){"use strict";t.d(s,{ob:function(){return a},wH:function(){return i}});let a={CACHE:{STALE_TIME:3e4,REFETCH_INTERVAL:3e5,REQUEST_TIMEOUT:1e4},SESSION:{CHECK_INTERVAL:6e4,WARNING_TIME:3e5},LOGGING:{ENABLED:!1,MIN_LEVEL:"error"},SUPABASE:{CONNECTION_POOL_SIZE:10,CONNECTION_TIMEOUT:5e3,AUTO_RETRY:!0,MAX_RETRIES:3,SINGLETON_MODE:!0,CHECK_INITIALIZATION:!0}},i=function(e){for(var s=arguments.length,t=Array(s>1?s-1:0),i=1;i<s;i++)t[i-1]=arguments[i];if(!a.LOGGING.ENABLED)return;let r=["debug","info","warn","error"];r.indexOf(e)>=r.indexOf(a.LOGGING.MIN_LEVEL)&&console[e](...t)}},2141:function(e,s,t){"use strict";t.r(s),t.d(s,{supabase:function(){return l},supabaseAdmin:function(){return n}});var a=t(63887);let i="https://pbdsuhmwxqiwbpgyrhqt.supabase.co";function r(e,s,t){return(0,a.eI)(e,s,{...t,auth:{...t.auth,storage:window.localStorage,storageKey:"supabase.auth.token",flowType:"pkce",debug:!1,persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}})}let{supabase:l,supabaseAdmin:n}=function(){if(!globalThis.__supabaseInitialized){if(globalThis.__supabase)try{var e,s;null===(e=(s=globalThis.__supabase).removeAllChannels)||void 0===e||e.call(s)}catch(e){}globalThis.__supabase=r(i,"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBiZHN1aG13eHFpd2JwZ3lyaHF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwODYyMzMsImV4cCI6MjA3NDY2MjIzM30.u5TqGGpULVAD062GT3zbfdC5RwOrj-jacJhWNSbfqus",{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}}),globalThis.__supabaseAdmin=r(i,"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBiZHN1aG13eHFpd2JwZ3lyaHF0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1OTA4NjIzMywiZXhwIjoyMDc0NjYyMjMzfQ.vZDNEvaGYn4-FAvyym69OQxFZkpc4m1ufcCn45Jn3jE",{auth:{persistSession:!1,autoRefreshToken:!1}}),globalThis.__supabaseInitialized=!0}return{supabase:globalThis.__supabase,supabaseAdmin:globalThis.__supabaseAdmin}}()},48736:function(e,s,t){"use strict";t.d(s,{Z:function(){return a}});let a=(0,t(39763).Z)("FileText",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"16",x2:"8",y1:"13",y2:"13",key:"14keom"}],["line",{x1:"16",x2:"8",y1:"17",y2:"17",key:"17nazh"}],["line",{x1:"10",x2:"8",y1:"9",y2:"9",key:"1a5vjj"}]])}},function(e){e.O(0,[8829,8931,2971,2117,1744],function(){return e(e.s=86206)}),_N_E=e.O()}]);